<html>
<head>
<title>auth.ts</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #2aacb8;}
.s5 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
auth.ts</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s2">{ </span><span class="s1">Router </span><span class="s2">} </span><span class="s1">from </span><span class="s3">&quot;express&quot;</span><span class="s2">;</span>
<span class="s0">import </span><span class="s1">bcrypt from </span><span class="s3">&quot;bcrypt&quot;</span><span class="s2">;</span>
<span class="s0">import </span><span class="s1">crypto from </span><span class="s3">&quot;crypto&quot;</span><span class="s2">;</span>
<span class="s0">import </span><span class="s2">{ </span><span class="s1">pool </span><span class="s2">} </span><span class="s1">from </span><span class="s3">&quot;../db&quot;</span><span class="s2">;</span>

<span class="s0">export const </span><span class="s1">authRouter </span><span class="s2">= </span><span class="s1">Router</span><span class="s2">();</span>

<span class="s0">function </span><span class="s1">makeSessionId</span><span class="s2">() {</span>
  <span class="s0">return </span><span class="s1">crypto</span><span class="s2">.</span><span class="s1">randomBytes</span><span class="s2">(</span><span class="s4">32</span><span class="s2">).</span><span class="s1">toString</span><span class="s2">(</span><span class="s3">&quot;base64url&quot;</span><span class="s2">);</span>
<span class="s2">}</span>

<span class="s5">// Register</span>
<span class="s1">authRouter</span><span class="s2">.</span><span class="s1">post</span><span class="s2">(</span><span class="s3">&quot;/register&quot;</span><span class="s2">, </span><span class="s1">async </span><span class="s2">(</span><span class="s1">req</span><span class="s2">, </span><span class="s1">res</span><span class="s2">) =&gt; {</span>
  <span class="s0">const </span><span class="s2">{ </span><span class="s1">username</span><span class="s2">, </span><span class="s1">email</span><span class="s2">, </span><span class="s1">password</span><span class="s2">, </span><span class="s1">first_name</span><span class="s2">, </span><span class="s1">last_name </span><span class="s2">} = </span><span class="s1">req</span><span class="s2">.</span><span class="s1">body</span><span class="s2">;</span>

  <span class="s5">// Make names required (matches your DB NOT NULL columns)</span>
  <span class="s0">if </span><span class="s2">(!</span><span class="s1">username </span><span class="s2">|| !</span><span class="s1">email </span><span class="s2">|| !</span><span class="s1">password </span><span class="s2">|| !</span><span class="s1">first_name </span><span class="s2">|| !</span><span class="s1">last_name</span><span class="s2">) {</span>
    <span class="s0">return </span><span class="s1">res</span><span class="s2">.</span><span class="s1">status</span><span class="s2">(</span><span class="s4">400</span><span class="s2">).</span><span class="s1">send</span><span class="s2">(</span><span class="s3">&quot;Missing fields&quot;</span><span class="s2">);</span>
  <span class="s2">}</span>

  <span class="s0">const </span><span class="s1">passwordHash </span><span class="s2">= </span><span class="s0">await </span><span class="s1">bcrypt</span><span class="s2">.</span><span class="s1">hash</span><span class="s2">(</span><span class="s1">password</span><span class="s2">, </span><span class="s4">10</span><span class="s2">);</span>

  <span class="s0">try </span><span class="s2">{</span>
    <span class="s5">// users.id is UUID (generated by DB default), password_hash is NOT NULL</span>
    <span class="s0">const </span><span class="s1">userResult </span><span class="s2">= </span><span class="s0">await </span><span class="s1">pool</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span>
      <span class="s3">`</span>
      <span class="s3">INSERT INTO users (username, email, first_name, last_name, password_hash) 
      VALUES ($1, $2, $3, $4, $5) 
      RETURNING id, username, email, first_name, last_name 
      `</span><span class="s2">,</span>
      <span class="s2">[</span><span class="s1">username</span><span class="s2">.</span><span class="s1">trim</span><span class="s2">(), </span><span class="s1">email</span><span class="s2">.</span><span class="s1">trim</span><span class="s2">().</span><span class="s1">toLowerCase</span><span class="s2">(), </span><span class="s1">first_name</span><span class="s2">.</span><span class="s1">trim</span><span class="s2">(), </span><span class="s1">last_name</span><span class="s2">.</span><span class="s1">trim</span><span class="s2">(), </span><span class="s1">passwordHash</span><span class="s2">]</span>
    <span class="s2">);</span>

    <span class="s0">const </span><span class="s1">newUser </span><span class="s2">= </span><span class="s1">userResult</span><span class="s2">.</span><span class="s1">rows</span><span class="s2">[</span><span class="s4">0</span><span class="s2">];</span>

    <span class="s0">const </span><span class="s1">sessionId </span><span class="s2">= </span><span class="s1">makeSessionId</span><span class="s2">();</span>
    <span class="s0">await </span><span class="s1">pool</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span>
      <span class="s3">`INSERT INTO sessions (session_id, user_id) VALUES ($1, $2)`</span><span class="s2">,</span>
      <span class="s2">[</span><span class="s1">sessionId</span><span class="s2">, </span><span class="s1">newUser</span><span class="s2">.</span><span class="s1">id</span><span class="s2">]</span>
    <span class="s2">);</span>

    <span class="s0">return </span><span class="s1">res</span><span class="s2">.</span><span class="s1">json</span><span class="s2">({ </span><span class="s1">session_id</span><span class="s2">: </span><span class="s1">sessionId</span><span class="s2">, </span><span class="s1">user</span><span class="s2">: </span><span class="s1">newUser </span><span class="s2">});</span>
  <span class="s2">} </span><span class="s0">catch </span><span class="s2">(</span><span class="s1">e</span><span class="s2">: </span><span class="s1">any</span><span class="s2">) {</span>
    <span class="s5">// Only return &quot;already exists&quot; for real unique violations</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">e</span><span class="s2">?.</span><span class="s1">code </span><span class="s2">=== </span><span class="s3">&quot;23505&quot;</span><span class="s2">) {</span>
      <span class="s0">return </span><span class="s1">res</span><span class="s2">.</span><span class="s1">status</span><span class="s2">(</span><span class="s4">409</span><span class="s2">).</span><span class="s1">send</span><span class="s2">(</span><span class="s3">&quot;Username or email already exists&quot;</span><span class="s2">);</span>
    <span class="s2">}</span>
    <span class="s1">console</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s3">&quot;REGISTER ERROR:&quot;</span><span class="s2">, </span><span class="s1">e</span><span class="s2">);</span>
    <span class="s0">return </span><span class="s1">res</span><span class="s2">.</span><span class="s1">status</span><span class="s2">(</span><span class="s4">500</span><span class="s2">).</span><span class="s1">send</span><span class="s2">(</span><span class="s1">e</span><span class="s2">?.</span><span class="s1">detail </span><span class="s2">|| </span><span class="s1">e</span><span class="s2">?.</span><span class="s1">message </span><span class="s2">|| </span><span class="s3">&quot;Server error&quot;</span><span class="s2">);</span>
  <span class="s2">}</span>
<span class="s2">});</span>

<span class="s5">// Login</span>
<span class="s1">authRouter</span><span class="s2">.</span><span class="s1">post</span><span class="s2">(</span><span class="s3">&quot;/login&quot;</span><span class="s2">, </span><span class="s1">async </span><span class="s2">(</span><span class="s1">req</span><span class="s2">, </span><span class="s1">res</span><span class="s2">) =&gt; {</span>
  <span class="s0">const </span><span class="s2">{ </span><span class="s1">emailOrUsername</span><span class="s2">, </span><span class="s1">password </span><span class="s2">} = </span><span class="s1">req</span><span class="s2">.</span><span class="s1">body</span><span class="s2">;</span>
  <span class="s0">if </span><span class="s2">(!</span><span class="s1">emailOrUsername </span><span class="s2">|| !</span><span class="s1">password</span><span class="s2">) </span><span class="s0">return </span><span class="s1">res</span><span class="s2">.</span><span class="s1">status</span><span class="s2">(</span><span class="s4">400</span><span class="s2">).</span><span class="s1">send</span><span class="s2">(</span><span class="s3">&quot;Missing fields&quot;</span><span class="s2">);</span>

  <span class="s0">try </span><span class="s2">{</span>
    <span class="s0">const </span><span class="s1">result </span><span class="s2">= </span><span class="s0">await </span><span class="s1">pool</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span>
      <span class="s3">`</span>
      <span class="s3">SELECT id, username, email, first_name, last_name, password_hash 
      FROM users 
      WHERE lower(email) = lower($1) OR username = $1 
      LIMIT 1 
      `</span><span class="s2">,</span>
      <span class="s2">[</span><span class="s1">String</span><span class="s2">(</span><span class="s1">emailOrUsername</span><span class="s2">).</span><span class="s1">trim</span><span class="s2">()]</span>
    <span class="s2">);</span>

    <span class="s0">const </span><span class="s1">user </span><span class="s2">= </span><span class="s1">result</span><span class="s2">.</span><span class="s1">rows</span><span class="s2">[</span><span class="s4">0</span><span class="s2">];</span>
    <span class="s0">if </span><span class="s2">(!</span><span class="s1">user</span><span class="s2">) </span><span class="s0">return </span><span class="s1">res</span><span class="s2">.</span><span class="s1">status</span><span class="s2">(</span><span class="s4">401</span><span class="s2">).</span><span class="s1">send</span><span class="s2">(</span><span class="s3">&quot;Invalid login&quot;</span><span class="s2">);</span>

    <span class="s0">const </span><span class="s1">ok </span><span class="s2">= </span><span class="s0">await </span><span class="s1">bcrypt</span><span class="s2">.</span><span class="s1">compare</span><span class="s2">(</span><span class="s1">password</span><span class="s2">, </span><span class="s1">user</span><span class="s2">.</span><span class="s1">password_hash</span><span class="s2">);</span>
    <span class="s0">if </span><span class="s2">(!</span><span class="s1">ok</span><span class="s2">) </span><span class="s0">return </span><span class="s1">res</span><span class="s2">.</span><span class="s1">status</span><span class="s2">(</span><span class="s4">401</span><span class="s2">).</span><span class="s1">send</span><span class="s2">(</span><span class="s3">&quot;Invalid login&quot;</span><span class="s2">);</span>

    <span class="s0">const </span><span class="s1">sessionId </span><span class="s2">= </span><span class="s1">makeSessionId</span><span class="s2">();</span>
    <span class="s0">await </span><span class="s1">pool</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span>
      <span class="s3">`INSERT INTO sessions (session_id, user_id) VALUES ($1, $2)`</span><span class="s2">,</span>
      <span class="s2">[</span><span class="s1">sessionId</span><span class="s2">, </span><span class="s1">user</span><span class="s2">.</span><span class="s1">id</span><span class="s2">]</span>
    <span class="s2">);</span>

    <span class="s0">return </span><span class="s1">res</span><span class="s2">.</span><span class="s1">json</span><span class="s2">({</span>
      <span class="s1">session_id</span><span class="s2">: </span><span class="s1">sessionId</span><span class="s2">,</span>
      <span class="s1">user</span><span class="s2">: {</span>
        <span class="s1">id</span><span class="s2">: </span><span class="s1">user</span><span class="s2">.</span><span class="s1">id</span><span class="s2">,</span>
        <span class="s1">username</span><span class="s2">: </span><span class="s1">user</span><span class="s2">.</span><span class="s1">username</span><span class="s2">,</span>
        <span class="s1">email</span><span class="s2">: </span><span class="s1">user</span><span class="s2">.</span><span class="s1">email</span><span class="s2">,</span>
        <span class="s1">first_name</span><span class="s2">: </span><span class="s1">user</span><span class="s2">.</span><span class="s1">first_name</span><span class="s2">,</span>
        <span class="s1">last_name</span><span class="s2">: </span><span class="s1">user</span><span class="s2">.</span><span class="s1">last_name</span><span class="s2">,</span>
      <span class="s2">},</span>
    <span class="s2">});</span>
  <span class="s2">} </span><span class="s0">catch </span><span class="s2">(</span><span class="s1">e</span><span class="s2">: </span><span class="s1">any</span><span class="s2">) {</span>
    <span class="s1">console</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s3">&quot;LOGIN ERROR:&quot;</span><span class="s2">, </span><span class="s1">e</span><span class="s2">);</span>
    <span class="s0">return </span><span class="s1">res</span><span class="s2">.</span><span class="s1">status</span><span class="s2">(</span><span class="s4">500</span><span class="s2">).</span><span class="s1">send</span><span class="s2">(</span><span class="s1">e</span><span class="s2">?.</span><span class="s1">detail </span><span class="s2">|| </span><span class="s1">e</span><span class="s2">?.</span><span class="s1">message </span><span class="s2">|| </span><span class="s3">&quot;Server error&quot;</span><span class="s2">);</span>
  <span class="s2">}</span>
<span class="s2">});</span>

<span class="s5">// Current user (protected)</span>
<span class="s1">authRouter</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;/me&quot;</span><span class="s2">, </span><span class="s1">async </span><span class="s2">(</span><span class="s1">req</span><span class="s2">, </span><span class="s1">res</span><span class="s2">) =&gt; {</span>
  <span class="s0">const </span><span class="s1">sessionId </span><span class="s2">= </span><span class="s1">req</span><span class="s2">.</span><span class="s1">header</span><span class="s2">(</span><span class="s3">&quot;x-session-id&quot;</span><span class="s2">);</span>
  <span class="s0">if </span><span class="s2">(!</span><span class="s1">sessionId</span><span class="s2">) </span><span class="s0">return </span><span class="s1">res</span><span class="s2">.</span><span class="s1">status</span><span class="s2">(</span><span class="s4">401</span><span class="s2">).</span><span class="s1">send</span><span class="s2">(</span><span class="s3">&quot;Missing session&quot;</span><span class="s2">);</span>

  <span class="s0">try </span><span class="s2">{</span>
    <span class="s0">const </span><span class="s1">result </span><span class="s2">= </span><span class="s0">await </span><span class="s1">pool</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span>
      <span class="s3">`</span>
      <span class="s3">SELECT u.id, u.username, u.email, u.first_name, u.last_name 
      FROM sessions s 
      JOIN users u ON u.id = s.user_id 
      WHERE s.session_id = $1 
      `</span><span class="s2">,</span>
      <span class="s2">[</span><span class="s1">sessionId</span><span class="s2">]</span>
    <span class="s2">);</span>

    <span class="s0">const </span><span class="s1">me </span><span class="s2">= </span><span class="s1">result</span><span class="s2">.</span><span class="s1">rows</span><span class="s2">[</span><span class="s4">0</span><span class="s2">];</span>
    <span class="s0">if </span><span class="s2">(!</span><span class="s1">me</span><span class="s2">) </span><span class="s0">return </span><span class="s1">res</span><span class="s2">.</span><span class="s1">status</span><span class="s2">(</span><span class="s4">401</span><span class="s2">).</span><span class="s1">send</span><span class="s2">(</span><span class="s3">&quot;Invalid session&quot;</span><span class="s2">);</span>
    <span class="s0">return </span><span class="s1">res</span><span class="s2">.</span><span class="s1">json</span><span class="s2">(</span><span class="s1">me</span><span class="s2">);</span>
  <span class="s2">} </span><span class="s0">catch </span><span class="s2">(</span><span class="s1">e</span><span class="s2">: </span><span class="s1">any</span><span class="s2">) {</span>
    <span class="s1">console</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s3">&quot;ME ERROR:&quot;</span><span class="s2">, </span><span class="s1">e</span><span class="s2">);</span>
    <span class="s0">return </span><span class="s1">res</span><span class="s2">.</span><span class="s1">status</span><span class="s2">(</span><span class="s4">500</span><span class="s2">).</span><span class="s1">send</span><span class="s2">(</span><span class="s1">e</span><span class="s2">?.</span><span class="s1">detail </span><span class="s2">|| </span><span class="s1">e</span><span class="s2">?.</span><span class="s1">message </span><span class="s2">|| </span><span class="s3">&quot;Server error&quot;</span><span class="s2">);</span>
  <span class="s2">}</span>
<span class="s2">});</span>

<span class="s5">// Logout</span>
<span class="s1">authRouter</span><span class="s2">.</span><span class="s1">post</span><span class="s2">(</span><span class="s3">&quot;/logout&quot;</span><span class="s2">, </span><span class="s1">async </span><span class="s2">(</span><span class="s1">req</span><span class="s2">, </span><span class="s1">res</span><span class="s2">) =&gt; {</span>
  <span class="s0">const </span><span class="s1">sessionId </span><span class="s2">= </span><span class="s1">req</span><span class="s2">.</span><span class="s1">header</span><span class="s2">(</span><span class="s3">&quot;x-session-id&quot;</span><span class="s2">);</span>
  <span class="s0">if </span><span class="s2">(!</span><span class="s1">sessionId</span><span class="s2">) </span><span class="s0">return </span><span class="s1">res</span><span class="s2">.</span><span class="s1">status</span><span class="s2">(</span><span class="s4">200</span><span class="s2">).</span><span class="s1">json</span><span class="s2">({ </span><span class="s1">ok</span><span class="s2">: </span><span class="s0">true </span><span class="s2">});</span>

  <span class="s0">try </span><span class="s2">{</span>
    <span class="s0">await </span><span class="s1">pool</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;DELETE FROM sessions WHERE session_id = $1&quot;</span><span class="s2">, [</span><span class="s1">sessionId</span><span class="s2">]);</span>
    <span class="s0">return </span><span class="s1">res</span><span class="s2">.</span><span class="s1">json</span><span class="s2">({ </span><span class="s1">ok</span><span class="s2">: </span><span class="s0">true </span><span class="s2">});</span>
  <span class="s2">} </span><span class="s0">catch </span><span class="s2">(</span><span class="s1">e</span><span class="s2">: </span><span class="s1">any</span><span class="s2">) {</span>
    <span class="s1">console</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s3">&quot;LOGOUT ERROR:&quot;</span><span class="s2">, </span><span class="s1">e</span><span class="s2">);</span>
    <span class="s0">return </span><span class="s1">res</span><span class="s2">.</span><span class="s1">status</span><span class="s2">(</span><span class="s4">500</span><span class="s2">).</span><span class="s1">send</span><span class="s2">(</span><span class="s1">e</span><span class="s2">?.</span><span class="s1">detail </span><span class="s2">|| </span><span class="s1">e</span><span class="s2">?.</span><span class="s1">message </span><span class="s2">|| </span><span class="s3">&quot;Server error&quot;</span><span class="s2">);</span>
  <span class="s2">}</span>
<span class="s2">});</span>
</pre>
</body>
</html>